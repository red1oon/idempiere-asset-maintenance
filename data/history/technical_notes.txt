================================================================================
TECHNICAL NOTES - AssetMaintenance Module
================================================================================
Date: 2026-01-21
For: User Guide / Implementation Reference
================================================================================

1. STANDARD JOB → MAINTENANCE LINKING (Copy From Design)
--------------------------------------------------------------------------------
The Standard Job field (mp_jobstandar_id) in the Maintenance window is
READ-ONLY by design. This is intentional.

WORKFLOW:
1. Create a new Maintenance record
2. Assign an Asset to the record first
3. Click the "Copy From" button (not the field)
4. Select the Standard Job template
5. The process (MPCopyFromSJ) will:
   - Copy all tasks from mp_jobstandar_task → mp_maintain_task
   - Copy all resources for each task → mp_maintain_resource
   - Set the mp_jobstandar_id on the Maintenance record

RATIONALE:
- Prevents users from changing the Standard Job link without updating tasks
- Ensures tasks/resources are properly copied when a Standard Job is selected
- Users can customize the copied tasks/resources for that specific Maintenance

Reference: MPCopyFromSJ.java (org.maintenance.process)
Manual Reference: Page 15 - "Maintenance record" section


2. SQL DIRECT INJECTION vs SEQUENCE SYNCHRONIZATION
--------------------------------------------------------------------------------
ISSUE:
When sample data is loaded via direct SQL INSERT (bypassing iDempiere's
getNextID() routine), the AD_Sequence table is NOT automatically updated.
This causes DUPLICATE KEY errors when creating new records via the UI.

EXAMPLE ERROR MESSAGE:
  "Could not save record - Require unique data: - Please change information.:
   ERROR: duplicate key value violates unique constraint "mp_maintain_key"
   Detail: Key (mp_maintain_id)=(1000003) already exists."

EXAMPLE (after loading sample data):
  - mp_maintain has records with IDs up to: 1000208
  - AD_Sequence.CurrentNext for MP_Maintain: 1000004
  - Next UI insert tries ID 1000004 → DUPLICATE KEY ERROR

SOLUTION - Run "Sequence Check" Process:
  Menu: System Admin → General Rules → System Rules → Sequence Check
  Process Class: org.compiere.process.SequenceCheck
  Description: "Check System and Document Sequences"

This process scans all tables and updates AD_Sequence.CurrentNext to be
greater than MAX(primary_key_id) + 1 for each table.

IMPORTANT FOR USERS:
After applying GardenWorld_SampleData.sql or any direct SQL inserts,
ALWAYS run "Sequence Check" from System Admin before creating new records.

Affected sequences after sample data load (all MP_* tables need sync):
  MP_Maintain         - max: 1000208, seq was: 1000004
  MP_Maintain_Task    - max: 1000079, seq was: 1000001
  MP_JobStandar       - sample data IDs: 1000001-1000021
  MP_JobStandar_Task  - sample data IDs: 1000001-1000071
  MP_AssetMeter       - sample data IDs present
  MP_AssetMeter_Log   - sample data IDs present
  MP_Meter            - sample data IDs present

HOW TO RUN SEQUENCE CHECK:
  1. Login as System Administrator (SuperUser/System)
  2. Menu: System Admin → General Rules → System Rules → Sequence Check
  3. Click OK to run (no parameters needed)
  4. Process will update all sequences to MAX(id)+1


3. DOCUMENT SEQUENCE vs TABLE ID SEQUENCE
--------------------------------------------------------------------------------
Two types of sequences in iDempiere:
- Table ID Sequence: For primary keys (e.g., MP_Maintain_ID)
- Document Sequence: For document numbers (e.g., DocumentNo)

Both are stored in AD_Sequence but serve different purposes.
"Sequence Check" handles both types.


4. CODE REVIEW - AREAS FOR IMPROVEMENT
--------------------------------------------------------------------------------

4.1 PROCESS FEEDBACK MESSAGES
-----------------------------
MPCopyFromSJ.java (line 112):
  Current:  return "Copied";
  Issue:    No indication of HOW MANY tasks/resources were copied
  Suggest:  return "Copied " + taskCount + " tasks and " + resourceCount + " resources";

MPProcessOT.java (line 66):
  Current:  return "Task Not Completed";
  Good:     Clear message, but could specify WHICH tasks are incomplete
  Suggest:  return "Task Not Completed: " + incompleteCount + " task(s) still pending";

MPAssetPlanning.java (line 315):
  Current:  return("Number of records generated: "+counter);
  Status:   GOOD - Already provides useful feedback

4.2 HARDCODED SPANISH LABELS (Internationalization)
---------------------------------------------------
WMPGenerateOT.java:
  Line 355: columnNames.add("Generar OT");      // Should use Msg.translate()
  Line 356: columnNames.add(Msg.getMsg(Env.getCtx(), "Ciclo"));  // "Ciclo" needs AD_Message

WMPProgrammingOT.java, WMPRequestOT.java:
  Similar hardcoded labels exist - should use AD_Message for i18n

NOTE: These are cosmetic/usability improvements, not critical bugs.

4.3 SQL BEST PRACTICES
----------------------
Several files use string concatenation for SQL instead of prepared statements:
  - MPAssetPlanning.java lines 192-196 (UPDATE with string concat)
  - WMPGenerateOT.java line 606-610 (UPDATE with string concat)

Current:  "UPDATE MP_MAINTAIN SET PROMUSE="+prom+" WHERE..."
Better:   DB.executeUpdateEx("UPDATE MP_MAINTAIN SET PROMUSE=? WHERE...?", new Object[]{prom, id})

Not a security risk (values from DB), but prepared statements are cleaner.

4.4 WORKFLOW NOTES FOR USER GUIDE
---------------------------------
PROGNOSIS WORKFLOW:
  1. Setup: Meter → Standard Job (with Tasks) → Maintenance (Copy From) → Asset Meter
  2. Operations: Meter Log entries (daily/regular readings)
  3. Office: Run Prognosis → Prognosis Approval → Generate OT
  4. Workshop: Work Order → Complete Tasks → Process OT

MAINTENANCE "COPY FROM" BUTTON:
  - Appears on Maintenance window toolbar (gear icon menu)
  - Must assign Asset FIRST before using Copy From
  - Copy From populates Tasks and Resources tabs from selected Standard Job
  - Sets mp_jobstandar_id as reference (read-only after copy)

PROGRAMMING TYPES:
  'C' = Calendar-based (uses DateNextRun, Interval in days)
  'M' = Meter-based (uses NextMP, Interval in meter units, requires Meter Logs)

DOCUMENT STATUS FLOW:
  Drafted (DR) → Complete (CO) → Void (VO) if needed

4.5 THINGS NOT AVAILABLE (from original manual, page 21)
--------------------------------------------------------
1. No reports defined - users must create via Print Formats
2. No internal invoice generation for labor costing
3. No automatic housekeeping of old Meter Logs
4. Request OT generates Work Orders but no email notifications


5. NINJA SEQUENCE HANDLING - CORRECT APPROACH
--------------------------------------------------------------------------------

5.1 OLD NINJA (org.red1.ninja - MigrateExcelData.java) - CORRECT
----------------------------------------------------------------
The original Ninja properly handles sequences using iDempiere's built-in functions:

  MSequence seq = MSequence.get(Env.getCtx(), TableName);
  if (seq != null)
      REC_ID = "nextIDFunc(" + seq.getAD_Sequence_ID() + ", 'N') ";

The nextIDFunc() is a PostgreSQL function that:
  1. Reads CurrentNext from AD_Sequence
  2. Increments CurrentNext atomically
  3. Returns the ID for use in INSERT

This approach ensures AD_Sequence stays synchronized with actual data.

5.2 CURRENT NINJA (NinjaProcessor.java) - NEEDS FIX
---------------------------------------------------
FILE: org.idempiere.ninja/src/org/idempiere/ninja/core/NinjaProcessor.java

CURRENT BEHAVIOR (lines 1389-1391):
  int nextId = DB.getSQLValue(trxName,
      "SELECT COALESCE(MAX(" + table.getTableName() + "_ID), 999999) + 1 FROM " + tableName);

This uses MAX()+1 which does NOT update AD_Sequence - causing sequence mismatch.

PROPOSED FIX - Use proper iDempiere sequence:
  Replace MAX()+1 with MSequence approach:

  MSequence seq = MSequence.get(Env.getCtx(), table.getTableName());
  int nextId;
  if (seq != null) {
      // Use nextIDFunc which properly updates AD_Sequence
      nextId = DB.getSQLValue(trxName,
          "SELECT nextIDFunc(" + seq.getAD_Sequence_ID() + ", 'N')");
  } else {
      // Fallback for tables without sequence
      nextId = DB.getSQLValue(trxName,
          "SELECT COALESCE(MAX(" + table.getTableName() + "_ID), 999999) + 1 FROM " + table.getTableName());
  }

5.3 SILENTPIPER - STANDALONE OPERATION
--------------------------------------
SilentPiper operates without iDempiere runtime, so it cannot use MSequence.
For standalone operation, post-import sequence sync is required.

Option A: Call sequence sync SQL after all inserts:
  UPDATE AD_Sequence SET CurrentNext =
      (SELECT COALESCE(MAX(table_id), 0) + 1 FROM tablename)
  WHERE Name = 'tablename'

Option B: Document that user must run "Sequence Check" after pack application.

5.4 WORKAROUND FOR DIRECT SQL
-----------------------------
When loading data via direct SQL (like GardenWorld_SampleData.sql):
  1. Menu: System Admin → General Rules → System Rules → Sequence Check
  2. Click OK to run (no parameters needed)
  3. Process updates all sequences to MAX(id)+1


================================================================================
END OF NOTES
================================================================================
